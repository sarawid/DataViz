<!DOCTYPE html>
<head>
  <title>Games Rating: 2015 - 2019</title>
  <meta charset="utf-8">
  <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
  <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>
</head>

<body>

<div id="container"></div>

<script>
var	margin = {top: 30, right: 20, bottom: 30, left: 30},
    width = 500 - margin.left - margin.right,
    height = 220 - margin.top - margin.bottom;

    

x= d3.scaleLinear().range([0, width])
y= d3.scaleLinear().range([height, 0])
color= d3.scaleOrdinal(d3.schemeCategory10)


d3.csv("average-rating.csv", function( data) { 
  // console.log(data)
  color.domain(d3.keys(data).filter(function(key) {
            return key !== "average_rating" ;
    }));
  return data
  // .sort(function(x, y){
  //           return d3.ascending(x.year, y.year)|| d3.ascending(a.average_rating, b.average_rating);
  // })
}).then(function(data) {
  
  yaxis = d3.axisLeft().scale(y).ticks(15);
  xaxis = d3.axisBottom().scale(x).ticks(10);

  data = data.sort((x,y) => parseInt(x.average_rating) - parseInt(y.average_rating))

  var nested_data = d3.nest()
    .key(function(d) { return d.year; })
    .key(function(d) { return parseInt(Math.floor(d.average_rating)) ; })
    .key(function(d){return d.name;})
    .key(function(d){return d.users_rated;}) 
    // .key(function(d){return d.year;})
    //  i would remove the user rated and the year 
    .entries(data);
    console.log(nested_data)

  nested_data = nested_data.filter((x) => parseInt(x.key) > 2014 && parseInt(x.key) < 2020)
  nested_data = nested_data.sort((x,y) => parseInt(x.key) - parseInt(y.key))

  x.domain([0,d3.max(data, function(c) { return (  Math.floor(parseInt(c.average_rating))) })]);

  for(i2 = 0; i2 < nested_data.length; i2++){
    row = nested_data[i2].values
    for(i = x.domain()[0]; i <= x.domain()[1]; i++) {
      
      val = row.filter((val) => {
        return parseInt(val.key) == i;
      })[0]

      if(!val){
        row.splice(i, 0, {"key": "" + i, values: []});
      }
    }
    nested_data[i2].values=row
  }



  lookup=[1,2,3,4,5,6,7,8,9]
  line = d3.line()
   .x(function(d) { 
     //if(d.lookup)
     return x(parseInt(d.key)); 
    })
   .y(function(d) { return y(d.values.length); })
   ;

  y.domain([0, d3.max(nested_data, function(c) {
            return d3.max(c.values, function(d) {
                return d.values.length
              });
      })
    ]);

//------------------------------SVG-----------------------//
  var	chart = d3.select("body")
    .append("svg")
    .attr("width", width + margin.left + margin.right+100)
    .attr("height", height + margin.top + margin.bottom)
    .attr("transform", "translate(" + 50 + "," + 10 + ")")
    .append("g")


// ---------------------AXIS--------------------------------//
  chart.append("g")
    .attr("class", "xaxis")
    .attr("transform", "translate(50," + 170 + ")")
    .call(xaxis).style("font-size", "6px")
    // .style("text-anchor", "middle")
    // .text("Month");

  chart.append("g")
    .attr("class", "yaxis")
    .attr("transform", "translate(50,10)")  
    // add 10 down
    .call(yaxis).style("font-size", "6px")
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("dy", ".75em")


// ---------------------LINES--------------------------------//
  const lines = chart.selectAll(".lines")
            .data(nested_data)
            .enter()
            .append("g");

    lines.append("path")
  // .attr("class", "line")
      .attr("transform", "translate(50,10)")
      .attr("d", function(d) { 
        r=d.values

        
        return line(d.values); 

      })
      .style("stroke", function(d) {
          return color((d.key));
      })
      .style("fill", "none")

      var tooltip = d3.select("body")
        .append("div")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("visibility", "hidden")
        .style("background", "#000")
        .style("color", "#FFF")
        .text("a simple tooltip");

      lines.selectAll("circle")
      .data(function(d){
        
        return d.values
      })
      .enter()
      .append("circle")
      .attr("transform", "translate(50,10)")
      .attr("r", 3)
      .attr("cx", function(d){
        // d=d[1]
        // r=d.values
        // return function(r){
          return x(parseInt(d.key));
        // }
        
      })
      .attr("cy", function(d){
        // d=d[1]
        return y(d.values.length);
      })
      .attr("fill", "grey")
      .on("mouseover", function(d){
        
        // d=d[1]
        d3.select(this).transition()
        .duration(1)
        .attr("r", 10);
        tooltip.text("Sampley key: " + d.key); return tooltip.style("visibility", "visible");
      })
      .on("mousemove", function(){
        return tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
      })
      .on("mouseout", function(){
        d3.select(this).transition()
        .duration(1)
        .attr("r", 3);
        return tooltip.style("visibility", "hidden");
      });
    function mouseOver(){
      year="2015"
      rating=d.key
      // get top 5 games by user ratings where year is 2015 and average ratings is 7
      hover_date=data.filter((x)=>parseInt(x.year)==year && parseInt(x.average_rating)== parseInt(rating))
      hover_date = hover_date.sort((x,y) => parseInt(y.users_rated) - parseInt(x.users_rated)).slice(0, 5)

    }

})
</script>

</body>